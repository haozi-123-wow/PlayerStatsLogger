ä¸“ç”¨å¼€å‘æ–‡æ¡£ï¼šMinecraft ç©å®¶è¡Œä¸ºç»Ÿè®¡æ•°æ®æ’ä»¶

> **é¡¹ç›®åç§°**ï¼š`PlayerStatsLogger`
> **ç›®æ ‡å¹³å°**ï¼šPaper 1.21.1ï¼ˆBukkit APIï¼‰
> **ç”¨é€”è¯´æ˜**ï¼šé€šè¿‡ç›‘å¬ç©å®¶è¡Œä¸ºï¼Œä½¿ç”¨ Redis å®æ—¶ç¼“å­˜æ•°æ®ï¼Œå¹¶å®šæœŸè½ç›˜è‡³ MySQL
> **æ ¸å¿ƒåŠŸèƒ½**ï¼š
> - ç»Ÿè®¡æ¯ä¸ªç©å®¶ï¼šæŒ–æ˜æ–¹å—æ•°ã€æ”¾ç½®æ–¹å—æ•°ã€å‡»æ€æ•Œå¯¹ç”Ÿç‰©æ•°
> - æ‰€æœ‰å˜æ›´å…ˆå†™å…¥ **Redis**
> - å¼‚æ­¥æ‰¹é‡åŒæ­¥è‡³ **MySQL**
> - æ”¯æŒå¤šæœéƒ¨ç½²ä¸é«˜å¹¶å‘åœºæ™¯

---

## âœ… ä¸€ã€æ€»ä½“æ¶æ„å›¾ï¼ˆAI ç†è§£ç”¨ï¼‰

```text
[ç©å®¶] 
   â†“ (è¡Œä¸º)
[Spigot äº‹ä»¶] â†’ ä¿®æ”¹ Redis Hash å€¼ï¼ˆINCRï¼‰
                   â†“
       [å®šæ—¶ä»»åŠ¡ | ç©å®¶ç¦»çº¿] â†’ è§¦å‘ saveToMySQL()
                                   â†“
                          [MySQL: player_statistics è¡¨]
```

- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šé«˜é¢‘æ“ä½œåœ¨å†…å­˜ï¼ˆRedisï¼‰ï¼Œä½é¢‘æŒä¹…åŒ–åˆ°ç£ç›˜ï¼ˆMySQLï¼‰
- âœ… **å¯æ‰©å±•æ€§**ï¼šæœªæ¥å¯åŠ  UUIDã€ç»´åº¦æ‹†åˆ†ã€æ’è¡Œæ¦œå¹¿æ’­ç­‰
- âœ… **å¥å£®æ€§**ï¼šæ–­ç”µåä» MySQL é‡æ–°åŠ è½½ï¼ŒRedis æ•…éšœé™çº§å¤„ç†ç•™ç©ºï¼ˆå¯é€‰ï¼‰

---

## ğŸ§± äºŒã€æœ€ç»ˆè¾“å‡ºæ–‡ä»¶æ¸…å•

| æ–‡ä»¶å | ç±»å‹ | ä½œç”¨ |
|--------|------|------|
| `PlayerStatsPlugin.java` | Java ä¸»ç±» | æ’ä»¶å…¥å£ï¼Œç®¡ç†ç”Ÿå‘½å‘¨æœŸ |
| `config.yml` | YAML é…ç½® | æ•°æ®åº“å’Œ Redis è¿æ¥ä¿¡æ¯ |
| `pom.xml` | Maven æ„å»ºæ–‡ä»¶ | ä¾èµ–ç®¡ç†ä¸æ‰“åŒ… |
| `database_init.sql` | SQL è„šæœ¬ | åˆ›å»ºæ•°æ®è¡¨ |
| ï¼ˆæ— é¢å¤–ç±»ï¼‰ | â€”â€” | ä½¿ç”¨ Jedis ç›´è¿ Redisï¼Œæ— éœ€å°è£…å®ä½“ |

---

## ğŸ—ƒï¸ ä¸‰ã€æ•°æ®åº“è®¾è®¡ï¼ˆMySQLï¼‰

### è¡¨åï¼š`player_statistics`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | å«ä¹‰ |
|--------|------|------|------|
| `player_name` | VARCHAR(16) | NOT NULL, UNIQUE | ç©å®¶åç§°ï¼ˆæš‚ç”¨åå­—ï¼Œå»ºè®®æœªæ¥å‡çº§ä¸º UUIDï¼‰ |
| `blocks_broken` | INT | DEFAULT 0 | æŒ–æ˜æ€»æ•° |
| `blocks_placed` | INT | DEFAULT 0 | æ”¾ç½®æ€»æ•° |
| `mobs_killed` | INT | DEFAULT 0 | å‡»æ€æ•Œå¯¹ç”Ÿç‰©æ€»æ•° |
| `last_seen` | TIMESTAMP | DEFAULT NOW ON UPDATE | æœ€åæ´»è·ƒæ—¶é—´ |

### å»ºè¡¨è¯­å¥ï¼ˆ`database_init.sql`ï¼‰
```sql
CREATE TABLE IF NOT EXISTS player_statistics (
    player_name VARCHAR(16) PRIMARY KEY,
    blocks_broken INT NOT NULL DEFAULT 0,
    blocks_placed INT NOT NULL DEFAULT 0,
    mobs_killed INT NOT NULL DEFAULT 0,
    last_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## âš¡ å››ã€ç¼“å­˜è®¾è®¡ï¼ˆRedisï¼‰

### ä½¿ç”¨æ•°æ®ç»“æ„ï¼š**Hash**

#### Redis Key æ ¼å¼ï¼š
```
player_stats:<player_name>
```

#### Fields:
- `"blocks_broken"` â†’ æ•°å€¼ï¼ˆå­—ç¬¦ä¸²æ•´æ•°ï¼‰
- `"blocks_placed"` â†’ æ•°å€¼
- `"mobs_killed"` â†’ æ•°å€¼

#### ç¤ºä¾‹æ“ä½œï¼š
```bash
HINCRBY player_stats:Steve blocks_broken 1
HGETALL player_stats:Alice
```

> âœ… åŸå­æ“ä½œä¿éšœå¹¶å‘å®‰å…¨
> âœ… å¤šæœåŠ¡å™¨å…±äº«çŠ¶æ€
> âœ… æ–­ç”µä¸¢å¤±é£é™©ï¼Ÿâ†’ å®šæ—¶è½åº“é™ä½å½±å“

---

## ğŸ”Œ äº”ã€é…ç½®æ–‡ä»¶ï¼ˆ`config.yml`ï¼‰

è·¯å¾„ï¼š`plugins/PlayerStatsLogger/config.yml`

```yaml
# MySQL æ•°æ®åº“é…ç½®
database:
  host: "localhost"
  port: 3306
  name: "minecraft_stats"
  username: "mc_stats"
  password: "secure_password_123"
  use_ssl: false
  auto_reconnect: true

# Redis ç¼“å­˜é…ç½®
redis:
  host: "localhost"
  port: 6379
  password: ""        # è‹¥æœªè®¾ç½®å¯†ç ï¼Œè¯·ç•™ç©ºæˆ–åˆ é™¤å­—æ®µ
  database: 0         # Redis é»˜è®¤ db 0
  timeout_ms: 2000    # è¿æ¥è¶…æ—¶æ—¶é—´

# æ’ä»¶è¿è¡Œå‚æ•°
debug: false
auto_save_interval_minutes: 2   # è‡ªåŠ¨å°† Redis æ•°æ®åŒæ­¥åˆ° MySQL çš„é—´éš”
```

> âœ… æ‰€æœ‰è¿æ¥å‚æ•°å¿…é¡»ä»è¯¥æ–‡ä»¶è¯»å–

---

## ğŸ”§ å…­ã€ä¸»æ’ä»¶ç±»å®šä¹‰ï¼ˆ`PlayerStatsPlugin.java`ï¼‰

### ç±»å£°æ˜
```java
public class PlayerStatsPlugin extends JavaPlugin {
    private HikariDataSource mysqlPool;
    private JedisPool redisPool;
    private final Set<String> dirtyPlayers = ConcurrentHashMap.newKeySet(); // éœ€è¦ä¿å­˜çš„ç©å®¶åå•
}
```

---

### ç”Ÿå‘½å‘¨æœŸæ–¹æ³•è¦æ±‚

#### `onEnable()`
1. ä¿å­˜å¼•ç”¨ï¼š`instance = this`
2. ä¿å­˜é»˜è®¤é…ç½®æ–‡ä»¶ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
3. åŠ è½½ `config.yml`
4. åˆå§‹åŒ– **MySQL HikariCP è¿æ¥æ± **
5. åˆå§‹åŒ– **JedisPoolï¼ˆRedis å®¢æˆ·ç«¯ï¼‰**
6. åˆ›å»º MySQL æ•°æ®è¡¨ï¼ˆæ‰§è¡Œä¸€æ¬¡ï¼‰
7. æ³¨å†Œä»¥ä¸‹äº‹ä»¶ç›‘å¬å™¨ï¼š
    - `BlockBreakEvent`
    - `BlockPlaceEvent`
    - `EntityDeathEvent`
    - `PlayerQuitEvent`
8. å¯åŠ¨åå°å®šæ—¶ä»»åŠ¡ï¼šæ¯ N åˆ†é’Ÿè°ƒç”¨ `flushDirtyData()` åŒæ­¥è„æ•°æ®

#### `onDisable()`
1. è°ƒç”¨ `flushAllToMySQL()` ç¡®ä¿æ‰€æœ‰æœªä¿å­˜æ•°æ®è½ç›˜
2. å…³é—­ `redisPool` å’Œ `mysqlPool`

---

## ğŸ“¡ ä¸ƒã€äº‹ä»¶ç›‘å¬é€»è¾‘ï¼ˆå…¨éƒ¨å¼‚æ­¥æˆ–åŸå­æ›´æ–°ï¼‰

### 1. æ–¹å—ç ´åï¼š`BlockBreakEvent`
```java
@EventHandler
public void onBreak(BlockBreakEvent e) {
    Player p = e.getPlayer();
    updateRedis(p.getName(), "blocks_broken", 1);
}
```

### 2. æ–¹å—æ”¾ç½®ï¼š`BlockPlaceEvent`
```java
@EventHandler
public void onPlace(BlockPlaceEvent e) {
    Player p = e.getPlayer();
    updateRedis(p.getName(), "blocks_placed", 1);
}
```

### 3. ç”Ÿç‰©æ­»äº¡ä¸”ç”±ç©å®¶å‡»æ€ï¼š`EntityDeathEvent`
```java
@EventHandler
public void onKill(EntityDeathEvent e) {
    Player killer = e.getEntity().getKiller();
    if (killer == null) return;
    if (!isHostileMob(e.getEntity())) return;

    updateRedis(killer.getName(), "mobs_killed", 1);
}

private boolean isHostileMob(Entity entity) {
    return entity instanceof Monster || 
           entity.getType() == EntityType.WITHER || 
           entity.getType() == EntityType.ENDERMAN ||
           entity.getType() == EntityType.RAVAGER;
}
```

### å·¥å…·æ–¹æ³•ï¼š`updateRedis(...)`

```java
private void updateRedis(String playerName, String field, int delta) {
    try (Jedis jedis = redisPool.getResource()) {
        jedis.hincrBy("player_stats:" + playerName, field, delta);
        dirtyPlayers.add(playerName); // æ ‡è®°ä¸ºå¾…åŒæ­¥
    } catch (Exception ex) {
        if (getConfig().getBoolean("debug")) {
            getLogger().warning("Redis error for " + playerName + ": " + ex.getMessage());
        }
    }
}
```

---

## ğŸ’¾ å…«ã€æŒä¹…åŒ–é€»è¾‘ï¼šä» Redis å†™å› MySQL

### æ–¹æ³•ç­¾å
```java
public void savePlayerToMySQL(String playerName)
```

#### åŠŸèƒ½æè¿°ï¼š
1. ä» Redis è·å– `player_stats:<name>` çš„ä¸‰ä¸ªå­—æ®µå€¼
2. ä½¿ç”¨ **é¢„ç¼–è¯‘è¯­å¥ UPSERT** å†™å…¥ MySQL
3. æˆåŠŸååˆ é™¤ Redis ä¸­è¯¥ç©å®¶çš„æ‰€æœ‰å­—æ®µï¼ˆè¡¨ç¤ºå·²æäº¤ï¼‰
4. ç§»é™¤ `dirtyPlayers` ä¸­çš„æ ‡è®°

#### SQL è¯­å¥ï¼ˆå¤ç”¨å‹ï¼‰
```sql
INSERT INTO player_statistics (player_name, blocks_broken, blocks_placed, mobs_killed)
VALUES (?, ?, ?, ?)
ON DUPLICATE KEY UPDATE
blocks_broken = blocks_broken + VALUES(blocks_broken),
blocks_placed = blocks_placed + VALUES(blocks_placed),
mobs_killed = mobs_killed + VALUES(mobs_killed)
```

---

### Java å®ç°æ¡†æ¶ï¼š

```java
public void savePlayerToMySQL(String playerName) {
    Map<String, String> data;
    try (Jedis jedis = redisPool.getResource()) {
        data = jedis.hgetAll("player_stats:" + playerName);
    } catch (Exception e) {
        getLogger().severe("æ— æ³•ä» Redis è¯»å– " + playerName);
        return;
    }

    if (data.isEmpty()) {
        dirtyPlayers.remove(playerName);
        return;
    }

    try (Connection conn = mysqlPool.getConnection()) {
        PreparedStatement ps = conn.prepareStatement(
            "INSERT INTO player_statistics (player_name, blocks_broken, blocks_placed, mobs_killed) " +
            "VALUES (?, ?, ?, ?) ON DUPLICATE KEY UPDATE " +
            "blocks_broken = blocks_broken + VALUES(blocks_broken), " +
            "blocks_placed = blocks_placed + VALUES(blocks_placed), " +
            "mobs_killed = mobs_killed + VALUES(mobs_killed)"
        );

        ps.setString(1, playerName);
        ps.setInt(2, parseInt(data.get("blocks_broken")));
        ps.setInt(3, parseInt(data.get("blocks_placed")));
        ps.setInt(4, parseInt(data.get("mobs_killed")));
        ps.executeUpdate();

        // æ¸…ç† Redis å·²ä¿å­˜æ•°æ®
        try (Jedis jedis = redisPool.getResource()) {
            jedis.hdel("player_stats:" + playerName, "blocks_broken", "blocks_placed", "mobs_killed");
        }
        dirtyPlayers.remove(playerName);

    } catch (SQLException e) {
        getLogger().severe("æ•°æ®åº“å†™å…¥å¤±è´¥ï¼š" + e.getMessage());
    }
}

private int parseInt(String s) {
    return s == null || s.isEmpty() ? 0 : Integer.parseInt(s);
}
```

---

## ğŸ” ä¹ã€å®šæ—¶åŒæ­¥ä»»åŠ¡

```java
int minutes = getConfig().getInt("auto_save_interval_minutes", 2);
long ticks = minutes * 60 * 20L;  // è½¬æ¢ä¸º tick

Bukkit.getScheduler().runTaskTimerAsynchronously(this, () -> {
    if (dirtyPlayers.isEmpty()) return;
    for (String playerName : new HashSet<>(dirtyPlayers)) {
        savePlayerToMySQL(playerName);
    }
}, ticks, ticks); // åˆæ¬¡å»¶è¿Ÿåé‡å¤æ‰§è¡Œ
```

> ğŸ‘‰ åœ¨ `onEnable()` ä¸­å¯åŠ¨æ­¤ä»»åŠ¡

---

## ğŸšª åã€ç©å®¶é€€å‡ºäº‹ä»¶ï¼ˆè§¦å‘ç«‹å³ä¿å­˜ï¼‰

```java
@EventHandler
public void onQuit(PlayerQuitEvent e) {
    String name = e.getPlayer().getName();
    Bukkit.getScheduler().runTaskAsynchronously(this, () -> savePlayerToMySQL(name));
}
```

> â—æ³¨æ„ï¼šä¸é˜»å¡ä¸»çº¿ç¨‹

---

## ğŸ“¦ åä¸€ã€Maven æ„å»ºæ–‡ä»¶ï¼ˆ`pom.xml`ï¼‰

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.example</groupId>
    <artifactId>PlayerStatsLogger</artifactId>
    <version>1.0</version>
    <packaging>jar</packaging>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>

    <dependencies>
        <!-- Spigot API -->
        <dependency>
            <groupId>org.spigotmc</groupId>
            <artifactId>spigot-api</artifactId>
            <version>1.20.4-R0.1-SNAPSHOT</version>
            <scope>provided</scope>
        </dependency>

        <!-- MySQL Driver -->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>8.0.33</version>
        </dependency>

        <!-- Redis Client: Jedis -->
        <dependency>
            <groupId>redis.clients</groupId>
            <artifactId>jedis</artifactId>
            <version>5.1.0</version>
        </dependency>

        <!-- HikariCP è¿æ¥æ±  -->
        <dependency>
            <groupId>com.zaxxer</groupId>
            <artifactId>HikariCP</artifactId>
            <version>5.0.1</version>
        </dependency>
    </dependencies>

    <build>
        <finalName>PlayerStatsLogger</finalName>
        <plugins>
            <!-- Shade Plugin: æ‰“åŒ…æ‰€æœ‰ä¾èµ– -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-shade-plugin</artifactId>
                <version>3.5.0</version>
                <executions>
                    <execution>
                        <phase>package</phase>
                        <goals>
                            <goal>shade</goal>
                        </goals>
                        <configuration>
                            <relocations>
                                <relocation>
                                    <pattern>com.zaxxer.hikari</pattern>
                                    <shadedPattern>shaded.com.zaxxer.hikari</shadedPattern>
                                </relocation>
                                <relocation>
                                    <pattern>redis.clients</pattern>
                                    <shadedPattern>shaded.redis.clients</shadedPattern>
                                </relocation>
                            </relocations>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>

    <repositories>
        <repository>
            <id>spigot-repo</id>
            <url>https://hub.spigotmc.org/nexus/content/repositories/snapshots/</url>
        </repository>
    </repositories>
</project>
```

---

## ğŸ§ª åäºŒã€å¼‚å¸¸ä¸å®¹é”™è®¾è®¡ï¼ˆä¾› AI ç†è§£ï¼‰

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|---------|
| Redis è¿æ¥å¤±è´¥ | è®°å½•æ—¥å¿—ï¼Œè·³è¿‡æœ¬æ¬¡æ›´æ–°ï¼ˆä¸å½±å“æ¸¸æˆï¼‰ |
| MySQL å†™å…¥å¤±è´¥ | æ—¥å¿—æŠ¥è­¦ï¼Œä¿ç•™ `dirtyPlayers` æ ‡è®°é‡è¯• |
| æ’ä»¶é‡å¯ | ä» MySQL åŠ è½½å†å²æ€»æ•°ï¼ŒRedis ä¸­æ–°å¢è¡Œä¸ºç»§ç»­ç´¯åŠ  |
| ç©å®¶æ”¹å | ä¸å¤„ç†ï¼ˆåŸºäº `player_name`ï¼‰ï¼Œå»ºè®®æœªæ¥æ”¹ç”¨ UUID |

---

## ğŸ”š åä¸‰ã€æ€»ç»“å…³é”®è¯ï¼ˆä¾¿äº AI è®°å¿†ï¼‰

| ç±»åˆ« | å…³é”®è¯ |
|------|--------|
| æ’ä»¶å | `PlayerStatsLogger` |
| ä¸»ç±» | `PlayerStatsPlugin extends JavaPlugin` |
| ç¼“å­˜ | `Redis`, `Jedis`, `Hash`, `HINCRBY` |
| æŒä¹…åŒ– | `MySQL`, `HikariCP`, `UPSERT`, `ON DUPLICATE KEY UPDATE` |
| ç»Ÿè®¡å­—æ®µ | `blocks_broken`, `blocks_placed`, `mobs_killed` |
| Redis Key | `player_stats:<player_name>` |
| åŒæ­¥æœºåˆ¶ | `dirtyPlayers Set` + å®šæ—¶ä»»åŠ¡ + ç™»å‡ºè§¦å‘ |
| å®‰å…¨ | æ‰€æœ‰ DB/Redis æ“ä½œå¼‚æ­¥è¿›è¡Œ |

---
